<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Opening the bentobox • bentobox</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Opening the bentobox">
<meta property="og:description" content="bentobox">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">bentobox</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Introduction.html">Opening the bentobox</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/apeterson91/bentobox/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Introduction_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Opening the bentobox</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/apeterson91/bentobox/blob/master/vignettes/Introduction.Rmd"><code>vignettes/Introduction.Rmd</code></a></small>
      <div class="hidden name"><code>Introduction.Rmd</code></div>

    </div>

    
    
<div id="motivation" class="section level1">
<h1 class="hasAnchor">
<a href="#motivation" class="anchor"></a>Motivation</h1>
<p>The <code>bentobox</code> package ecosystem contains four packages that facilitate working with and modeling built environment(BE) data:</p>
<ul>
<li>
<code>rbenvo</code> A suite of objects and tools for working with the relational subject - BE data.</li>
<li>
<code>rsstap</code>: A package for modeling the population level effect of BE features (BEFs) on subjects: <span class="math inline">\(E[g(\mu_i)] = X_i^{T}\delta + f(BEF)\)</span>
</li>
<li>
<code>bendr</code>: A package for estimating clusters of spatial distributions of a BEF around subjects <span class="math inline">\(f(d) = \int \mathcal{K}(d|\theta)dG(\theta)\)</span>.</li>
<li>
<code>rstapDP</code>: A package for modeling the cluster level effects of BEFS on subjects: <span class="math inline">\(E[g(\mu_i)] = X_i^{T}\delta + f_i(BEF)\)</span>
</li>
</ul>
<p>The intent of packaging this software together is so that it may provide an “all-in-one” approach for those wishing to perform analysis on BEFs. In this vignette we’ll briefly show how the functions from these packages support one another and offer different methods of analyzing the environments in which we live.</p>
</div>
<div id="demonstration" class="section level1">
<h1 class="hasAnchor">
<a href="#demonstration" class="anchor"></a>Demonstration</h1>
<p>We’ll begin this demonstration by first loading <code>bentobox</code> which will, akin to the tidyverse, print out a message of which packages have been loaded, and any overlapping(or conflicting) functions which will be masked.</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">bentobox</span><span class="op">)</span>
<span class="co">#&gt; ── Attaching packages ───────────────────────────────────────────── bentobox 0.1.0 ──</span>
<span class="co">#&gt; ✓ rbenvo  1.0.4     ✓ rstapDP 0.1.4</span>
<span class="co">#&gt; ✓ rsstap  0.1.2     ✓ bendr   1.0.3</span>
<span class="co">#&gt; ── Conflicts ──────────────────────────────────────────────── bentobox_conflicts() ──</span>
<span class="co">#&gt; x rbenvo::filter() masks stats::filter()</span>
<span class="co">#&gt; x Rcpp::prompt()   masks utils::prompt()</span></pre></div>
<p>For this vignette we’ll use the California school obesity and Fast Food Restaurant (FFR) data, which have code to illustrate how they were downloaded and packaged <a href="https://github.com/apeterson91/rbenvo/blob/master/data-raw/CA.R">here</a>. We can create this dataset using the simple <code>create_CA_benvo()</code> command from <code>rbenvo</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="va">bdf</span> <span class="op">&lt;-</span> <span class="fu">create_CA_benvo</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Linking to GEOS 3.8.1, GDAL 3.1.1, PROJ 6.3.1</span></pre></div>
<p>Using the <code>active</code> API paradigm, popularized in the <a href="https://github.com/thomasp85/tidygraph">tidygraph</a> package, we can take a look at the current active BEF, which contains the pairwise school-FFR distances.</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="va">bdf</span>
<span class="co">#&gt; Active df:  FFR</span>
<span class="co">#&gt; # A tibble: 489,034 x 3</span>
<span class="co">#&gt;    cdscode        osm_id   Distance</span>
<span class="co">#&gt;    &lt;chr&gt;          &lt;chr&gt;       &lt;dbl&gt;</span>
<span class="co">#&gt;  1 19101991933399 60713740     5.91</span>
<span class="co">#&gt;  2 19647330100289 60713740     9.89</span>
<span class="co">#&gt;  3 19647330100867 60713740     9.55</span>
<span class="co">#&gt;  4 19647330101683 60713740     5.48</span>
<span class="co">#&gt;  5 19647330102426 60713740     6.37</span>
<span class="co">#&gt;  6 19647330106435 60713740     9.36</span>
<span class="co">#&gt;  7 19647330108886 60713740     7.89</span>
<span class="co">#&gt;  8 19647330109439 60713740     3.22</span>
<span class="co">#&gt;  9 19647330110304 60713740     8.82</span>
<span class="co">#&gt; 10 19647330111658 60713740     5.91</span>
<span class="co">#&gt; # … with 489,024 more rows</span></pre></div>
<p>In a similar manner, we can look at the relevant subject and bef data.</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="va">bdf</span> <span class="op">%&gt;%</span> <span class="fu">activate</span><span class="op">(</span><span class="va">subject</span><span class="op">)</span>
<span class="co">#&gt; Active df:  subject</span>
<span class="co">#&gt; Simple feature collection with 698 features and 7 fields</span>
<span class="co">#&gt; geometry type:  POINT</span>
<span class="co">#&gt; dimension:      XY</span>
<span class="co">#&gt; bbox:           xmin: -118.4958 ymin: 33.90556 xmax: -118.136 ymax: 34.29046</span>
<span class="co">#&gt; geographic CRS: WGS 84</span>
<span class="co">#&gt; # A tibble: 698 x 8</span>
<span class="co">#&gt;    cdscode Charter Grade     N Percent NoStud_Overweig… NoStud_NotOverw…</span>
<span class="co">#&gt;  * &lt;chr&gt;   &lt;fct&gt;   &lt;fct&gt; &lt;dbl&gt;   &lt;dbl&gt;            &lt;dbl&gt;            &lt;dbl&gt;</span>
<span class="co">#&gt;  1 141014… Charter 9        19    47.4                9               10</span>
<span class="co">#&gt;  2 191019… Charter 7        92    35.9               33               59</span>
<span class="co">#&gt;  3 191019… Charter 9        44    52.3               23               21</span>
<span class="co">#&gt;  4 191019… Tradit… 9        99    19.2               19               80</span>
<span class="co">#&gt;  5 196473… Charter 5        45    33.3               15               30</span>
<span class="co">#&gt;  6 196473… Charter 5       101    59.4               60               41</span>
<span class="co">#&gt;  7 196473… Charter 7       127    59.4               75               52</span>
<span class="co">#&gt;  8 196473… Charter 5       101    46.5               47               54</span>
<span class="co">#&gt;  9 196473… Charter 7       127    46.5               59               68</span>
<span class="co">#&gt; 10 196473… Charter 5        65    46.2               30               35</span>
<span class="co">#&gt; # … with 688 more rows, and 1 more variable: geometry &lt;POINT [°]&gt;</span></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="va">bdf</span> <span class="op">%&gt;%</span> <span class="fu">activate</span><span class="op">(</span><span class="va">bef_FFR</span><span class="op">)</span>
<span class="co">#&gt; Active df:  bef_FFR</span>
<span class="co">#&gt; Simple feature collection with 6621 features and 2 fields</span>
<span class="co">#&gt; geometry type:  POINT</span>
<span class="co">#&gt; dimension:      XY</span>
<span class="co">#&gt; bbox:           xmin: -118.644 ymin: 33.73657 xmax: -118.1552 ymax: 34.30866</span>
<span class="co">#&gt; geographic CRS: WGS 84</span>
<span class="co">#&gt; # A tibble: 6,621 x 3</span>
<span class="co">#&gt;    Name               osm_id                geometry</span>
<span class="co">#&gt;  * &lt;chr&gt;              &lt;chr&gt;              &lt;POINT [°]&gt;</span>
<span class="co">#&gt;  1 &lt;NA&gt;               60713740  (-118.1829 34.11479)</span>
<span class="co">#&gt;  2 Yoshinoya          72448982   (-118.216 34.07622)</span>
<span class="co">#&gt;  3 Jack in the Box    72448995   (-118.216 34.07669)</span>
<span class="co">#&gt;  4 Baja Fresh         344723703 (-118.3165 34.18557)</span>
<span class="co">#&gt;  5 Jersey Mike's Subs 344723888 (-118.3163 34.18562)</span>
<span class="co">#&gt;  6 Taco Bell          344727689 (-118.3191 34.18821)</span>
<span class="co">#&gt;  7 Baja Fresh         349339405 (-118.3275 34.09819)</span>
<span class="co">#&gt;  8 Chipotle           349340479 (-118.3768 34.07442)</span>
<span class="co">#&gt;  9 Subway             354910320 (-118.3149 34.26024)</span>
<span class="co">#&gt; 10 &lt;NA&gt;               358019457 (-118.3386 34.19783)</span>
<span class="co">#&gt; # … with 6,611 more rows</span></pre></div>
<div id="visualize" class="section level3">
<h3 class="hasAnchor">
<a href="#visualize" class="anchor"></a>Visualize</h3>
<p>If we’d like to visualize these data, one easy method would be to use the <code>plot_map</code> method available from <code>rbenvo</code>, for those <code>benvo's</code> that have <code>sf</code> information available, as we do here.</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">bdf</span>,<span class="st">'map'</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span> 
<span class="co">#&gt; Source : http://tile.stamen.com/terrain/10/174/407.png</span>
<span class="co">#&gt; Source : http://tile.stamen.com/terrain/10/175/407.png</span>
<span class="co">#&gt; Source : http://tile.stamen.com/terrain/10/174/408.png</span>
<span class="co">#&gt; Source : http://tile.stamen.com/terrain/10/175/408.png</span>
<span class="co">#&gt; Source : http://tile.stamen.com/terrain/10/174/409.png</span>
<span class="co">#&gt; Source : http://tile.stamen.com/terrain/10/175/409.png</span>
<span class="co">#&gt; Coordinate system already present. Adding new coordinate system, which will replace the existing one.</span></pre></div>
<p><img src="Introduction_files/figure-html/map-1.png" width="700"> This spatial visulization shows that most of the subjects (schools in our case) are clustered iwthin the interior of Los Angeles, as one might expect. However, we have FFRs both within and far away from L.A, though notably not very far east of the city. This could lead to an unintended <a href="https://en.wikipedia.org/wiki/Edge_effects">edge effect</a>. We’ll ignore this here, since we’re only interested in showing and modeling these data for illustrative purposes, but this would be of greater concern in an analysis intended to be more authoritative.</p>
</div>
<div id="model" class="section level2">
<h2 class="hasAnchor">
<a href="#model" class="anchor"></a>Model</h2>
<p>The first model we can fit to these data is the spatial aggregated predictor model, available via <code>rsstap</code>, which takes the following form for our data: <span class="math display">\[
\text{logit}(P(\text{obesity}|b_i)) = \mathbf{X}_i^T\mathbf{\delta} + f(FFR_i) + b_i\\
f(FFR_i) = \sum_{d \in \mathcal{D}}\sum_{l=1}^{10}\beta_l\phi_l(d)\\
b_i \sim N(0,\sigma^2_b).
\]</span></p>
<p>This model can be fit via the following R code.</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">sstap_glmer</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">NoStud_OverweightObese</span>,<span class="va">NoStud_NotOverweightObese</span><span class="op">)</span> <span class="op">~</span> <span class="va">Charter</span> <span class="op">+</span> <span class="va">Grade</span> <span class="op">+</span> <span class="fu">sap</span><span class="op">(</span><span class="va">FFR</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">cdscode</span><span class="op">)</span>,
                   benvo<span class="op">=</span><span class="va">bdf</span>,
                   family<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></pre></div>
<p>Similarly, the primary effect of interest - the FFR effect, can be plotted using <code>plot</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></pre></div>
<p><img src="Introduction_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<p>While this is not intended to be an authoritative result, as stated previously, the positive association between FFR exposure and childhood obesity is, at least, in line with what one might expect.</p>
<p>We could take this modeling strategy further, by estimating clusters of spatial distributions in FFR occurrence around schools via <a href="https://apeterson91.github.io/bendr/"><code>bendr</code></a>, or identify clusters of FFR effects via <a href="http://apeterson91.github.io/rstapDP"><code>rstapDP</code></a>, however, we’ll end this vignette here, leaving the links to those packages as a more in-depth resource for those interested in how those models are formulated.</p>
<p>The take-home message of this vignette is that by combining the custom modeling strategies of <code>rsstap</code>,<code>bendr</code> and <code>rstapDP</code> along with the intuitive tidygraph-like data structure available in <code>rbenvo</code>, the <code>bentobox</code> ecosystem offers those interested in studying the built environment a fundamental set of tools with which to analyze built environment data.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Adam Peterson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
